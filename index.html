<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ë—é–¥–∂–µ—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #fff);
      --text: var(--tg-theme-text-color, #000);
      --hint: var(--tg-theme-hint-color, #999);
      --btn: var(--tg-theme-button-color, #2481cc);
      --btn-text: var(--tg-theme-button-text-color, #fff);
      --secondary: var(--tg-theme-secondary-bg-color, #f0f0f0);
      --border: var(--tg-theme-hint-color, #e0e0e0);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg); color: var(--text); padding: 20px; min-height: 100vh;
      line-height: 1.5;
    }
    .header { 
      font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 24px; 
      background: linear-gradient(135deg, var(--btn), #1a73e8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; }
    button {
      background: linear-gradient(135deg, var(--btn), #1a5fd7); color: var(--btn-text); border: none; padding: 16px;
      border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer;
      transition: all 0.3s ease; text-align: center; box-shadow: 0 4px 12px rgba(36, 129, 204, 0.2);
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(36, 129, 204, 0.3); }
    button:active { opacity: 0.9; transform: translateY(0); }
    .output {
      background: var(--secondary); padding: 20px; border-radius: 16px;
      font-size: 15px; white-space: pre-line; min-height: 80px; color: var(--text);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border);
    }
    .auth-screen { text-align: center; padding: 40px; }
    .auth-screen p { margin: 16px 0; color: var(--hint); }
    .user-info { text-align: center; margin-bottom: 16px; font-size: 14px; color: var(--hint); }
    .logout { font-size: 12px; color: var(--hint); text-decoration: underline; cursor: pointer; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è -->
  <div id="authScreen" class="auth-screen">
    <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</h2>
    <p>–¢–≤—ñ–π ID: <span id="userId"></span></p>
    <p id="authMessage">–ü–µ—Ä–µ–≤—ñ—Ä—è—é –¥–æ—Å—Ç—É–ø...</p>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
  <div id="mainApp" class="hidden">
    <div class="user-info">
      –ü—Ä–∏–≤—ñ—Ç, <span id="userName"></span>! <span class="logout" onclick="logout()">–í–∏–π—Ç–∏</span>
    </div>
    <div class="header">üí∞ –ë—é–¥–∂–µ—Ç</div>
    <div class="grid">
      <button onclick="showAdd()">‚ûï –î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É</button>
      <button onclick="showSummary()">üìä –ü—ñ–¥—Å—É–º–æ–∫</button>
      <button onclick="showBalance()">üë• –ë–∞–ª–∞–Ω—Å</button>
      <button onclick="undoLast()">‚éå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button onclick="showLast()">üßæ –û—Å—Ç–∞–Ω–Ω—ñ</button>
      <button onclick="showSettings()">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
    </div>
    <div id="output" class="output">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
  </div>

  <!-- Popup –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤–∏—Ç—Ä–∞—Ç–∏ -->
  <div id="addPopup" class="popup hidden">
    <div class="popup-content">
      <h3>‚ûï –î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É</h3>
      <select id="categorySelect" class="input">
        <option value="">‚Äî –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è... ‚Äî</option>
      </select>
      <input type="number" id="amountInput" placeholder="–°—É–º–∞ (–≥—Ä–Ω)" class="input" min="1">
      <input type="text" id="noteInput" placeholder="–ù–æ—Ç–∞—Ç–∫–∞ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" class="input">
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="hidePopup('addPopup')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn btn-primary" onclick="saveExpense()">–î–æ–¥–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const ALLOWED_IDS = { '350174070': '–ì–ª—ñ–±', '387290608': '–î–∞—Ä º—è' };
    const API_URL = '';
    const userId = tg.initDataUnsafe?.user?.id?.toString() || '0';

    let isAuthorized = false;
    let userName = '';

    // === localStorage ===
    const storageKey = 'budget_app_auth';
    const saved = localStorage.getItem(storageKey);
    if (saved) {
      const data = JSON.parse(saved);
      if (data.userId === userId && ALLOWED_IDS[data.userId]) {
        isAuthorized = true;
        userName = ALLOWED_IDS[data.userId];
        document.getElementById('userName').textContent = userName;
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('authScreen').classList.add('hidden');
        showSummary();
      }
    }

    // === –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è ===
    document.getElementById('userId').textContent = userId;

    function checkAuth() {
      if (ALLOWED_IDS[userId]) {
        isAuthorized = true;
        userName = ALLOWED_IDS[userId];
        localStorage.setItem(storageKey, JSON.stringify({ userId, userName }));
        document.getElementById('userName').textContent = userName;
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        showSummary();
      } else {
        document.getElementById('authMessage').textContent = '–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ';
      }
    }

    function logout() {
      localStorage.removeItem(storageKey);
      location.reload();
    }

    // === –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê ===
    setTimeout(checkAuth, 500);  // ‚Üê –ê–í–¢–û–ú–ê–¢–ò–ß–ù–û —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫

    // === API ===
    async function api(action, data = {}) {
      if (!isAuthorized) return { error: '–ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è' };
      data.action = action; data.userId = userId;
      try {
        const res = await fetch(API_URL + '/' + action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        return await res.json();
      } catch (err) {
        return { error: '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π' };
      }
    }

    // (—ñ–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó ‚Äî showAdd, showSummary, etc.)

    // –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è
    if (isAuthorized) showSummary();
  </script>
</body>
</html>
