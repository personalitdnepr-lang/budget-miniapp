<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ë—é–¥–∂–µ—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #fff);
      --text: var(--tg-theme-text-color, #000);
      --hint: var(--tg-theme-hint-color, #999);
      --btn: var(--tg-theme-button-color, #2481cc);
      --btn-text: var(--tg-theme-button-text-color, #fff);
      --secondary: var(--tg-theme-secondary-bg-color, #f0f0f0);
      --border: var(--tg-theme-hint-color, #e0e0e0);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg); color: var(--text); padding: 20px; min-height: 100vh;
      line-height: 1.5;
    }
    .header { 
      font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 24px; 
      background: linear-gradient(135deg, var(--btn), #1a73e8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; }
    button {
      background: linear-gradient(135deg, var(--btn), #1a5fd7); color: var(--btn-text); border: none; padding: 16px;
      border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer;
      transition: all 0.3s ease; text-align: center; box-shadow: 0 4px 12px rgba(36, 129, 204, 0.2);
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(36, 129, 204, 0.3); }
    button:active { opacity: 0.9; transform: translateY(0); }
    .output {
      background: var(--secondary); padding: 20px; border-radius: 16px;
      font-size: 15px; white-space: pre-line; min-height: 80px; color: var(--text);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border);
    }
    .popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
    .popup-content { background: var(--bg); padding: 24px; border-radius: 20px; width: 90%; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); transform: scale(0.95); animation: popupIn 0.3s ease; }
    @keyframes popupIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .input { width: 100%; padding: 14px; margin: 12px 0; border: 1px solid var(--border); border-radius: 12px; font-size: 16px; transition: border-color 0.3s; }
    .input:focus { border-color: var(--btn); outline: none; }
    .btn-group { display: flex; gap: 12px; margin-top: 20px; }
    .btn { flex: 1; padding: 14px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: linear-gradient(135deg, var(--btn), #1a5fd7); color: var(--btn-text); }
    .btn-secondary { background: var(--secondary); color: var(--text); border: 1px solid var(--border); }
    .btn:hover { transform: translateY(-1px); }
    .hidden { display: none; }
    .loading { opacity: 0.6; pointer-events: none; }
    .auth-screen { text-align: center; padding: 40px; }
    .auth-screen p { margin: 16px 0; color: var(--hint); }
  </style>
</head>
<body>
  <div class="header">üí∞ –ë—é–¥–∂–µ—Ç</div>
  <div class="grid">
    <button onclick="showAdd()">‚ûï –î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É</button>
    <button onclick="showSummary()">üìä –ü—ñ–¥—Å—É–º–æ–∫</button>
    <button onclick="showBalance()">üë• –ë–∞–ª–∞–Ω—Å</button>
    <button onclick="undoLast()">‚éå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    <button onclick="showLast()">üßæ –û—Å—Ç–∞–Ω–Ω—ñ</button>
    <button onclick="showSettings()">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
  </div>
  <div id="output" class="output">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

  <div id="authScreen" class="auth-screen">
    <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</h2>
    <p>–¢–≤—ñ–π ID: <span id="userId"></span></p>
    <p>–î–æ—Å—Ç—É–ø –¥–æ–∑–≤–æ–ª–µ–Ω–æ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.</p>
    <button onclick="checkAuth()" class="btn btn-primary">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–æ—Å—Ç—É–ø</button>
  </div>

  <!-- Popup –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤–∏—Ç—Ä–∞—Ç–∏ -->
  <div id="addPopup" class="popup hidden">
    <div class="popup-content">
      <h3>‚ûï –î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É</h3>
      <select id="categorySelect" class="input">
        <option value="">‚Äî –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è... ‚Äî</option>
      </select>
      <input type="number" id="amountInput" placeholder="–°—É–º–∞ (–≥—Ä–Ω)" class="input" min="1">
      <input type="text" id="noteInput" placeholder="–ù–æ—Ç–∞—Ç–∫–∞ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" class="input">
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="hidePopup('addPopup')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn btn-primary" onclick="saveExpense()">–î–æ–¥–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const ALLOWED_IDS = [350174070, 387290608];
    const API_URL = '';  // –¢–æ–π —Å–∞–º–∏–π –¥–æ–º–µ–Ω
    const userId = tg.initDataUnsafe?.user?.id || 0;

    let isAuthorized = false;

    document.getElementById('userId').textContent = userId;

    function checkAuth() {
      if (ALLOWED_IDS.includes(userId)) {
        isAuthorized = true;
        document.getElementById('authScreen').classList.add('hidden');
        showSummary();
      } else {
        tg.showAlert('–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é —Å–ø–æ—á–∞—Ç–∫—É
    document.getElementById('authScreen').classList.remove('hidden');

    async function api(action, data = {}) {
      if (!isAuthorized) return { error: '–ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è —Å–ø–æ—á–∞—Ç–∫—É' };
      data.action = action; data.userId = userId;
      try {
        const res = await fetch(API_URL + '/' + action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        return await res.json();
      } catch (err) {
        console.error('API Error:', err);
        return { error: '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π' };
      }
    }

    async function loadCategories() {
      const res = await api('getCategories');
      const select = document.getElementById('categorySelect');
      select.innerHTML = '<option value="">‚Äî –û–±–µ—Ä—ñ—Ç—å ‚Äî</option>';
      if (res.categories && res.categories.length > 0) {
        res.categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat; opt.textContent = cat;
          select.appendChild(opt);
        });
      } else {
        select.innerHTML += '<option value="">–ù–µ–º–∞—î –∫–∞—Ç–µ–≥–æ—Ä—ñ–π</option>';
      }
    }

    function showPopup(id) {
      document.getElementById(id).classList.remove('hidden');
      if (id === 'addPopup') loadCategories();
    }

    function hidePopup(id) {
      document.getElementById(id).classList.add('hidden');
    }

    window.showAdd = () => showPopup('addPopup');
    window.showSummary = async () => {
      document.getElementById('output').innerText = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
      const res = await api('summary');
      document.getElementById('output').innerText = res.summary || res.error || '–ü—É—Å—Ç–æ';
    };
    window.showBalance = async () => {
      document.getElementById('output').innerText = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
      const res = await api('balance');
      document.getElementById('output').innerText = res.balance || '–ü–æ–º–∏–ª–∫–∞';
    };
    window.undoLast = async () => {
      const res = await api('undo');
      tg.showAlert(res.message || '–ì–æ—Ç–æ–≤–æ');
      showSummary();
    };
    window.showLast = async () => {
      document.getElementById('output').innerText = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
      const res = await api('last5');
      document.getElementById('output').innerText = res.last || '–ü—É—Å—Ç–æ';
    };
    window.showSettings = () => {
      tg.showAlert('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤ —á–∞—Ç—ñ:\n\n/setcat –ï–¥–∞ 25000\n/setpers –ì–ª—ñ–± 50000');
    };

    async function saveExpense() {
      const cat = document.getElementById('categorySelect').value;
      const amount = document.getElementById('amountInput').value;
      const note = document.getElementById('noteInput').value || '.';
      
      if (!cat || !amount || amount <= 0) {
        tg.showAlert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Å—É–º—É —Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é');
        return;
      }

      const res = await api('addExpense', { cat, amount, note });
      tg.showAlert(res.message || res.error || '–î–æ–¥–∞–Ω–æ');
      hidePopup('addPopup');
      showSummary();
    }
  </script>
</body>
</html>
